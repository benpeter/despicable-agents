# Delegation Plan: Eliminate Merge Conflicts from Nefario Reports

**Team name**: report-ci
**Description**: Move nefario report index generation from local orchestration to CI, eliminating merge conflicts during parallel work.

## Conflict Resolutions

None. Both specialists are fully aligned: iac-minion handles CI workflow, devx-minion handles tracked removal and doc edits. No overlapping recommendations.

## Consolidation Decision

Both specialists recommended consolidating into fewer tasks. Agreed. The final plan has 3 tasks:

1. One task for the GitHub Actions workflow (iac-minion's domain)
2. One task for git rm + gitignore (must be a separate git operation)
3. One task for all documentation edits (4 files, paragraph-level changes)

All three tasks are independent and can run in parallel. They land in the same PR, so atomicity is preserved at merge time.

---

### Task 1: Create GitHub Actions workflow for index regeneration

- **Agent**: iac-minion
- **Model**: sonnet
- **Mode**: default
- **Blocked by**: none
- **Approval gate**: no
- **Prompt**: |
    Create the file `.github/workflows/regenerate-report-index.yml` with the
    following exact content:

    ```yaml
    name: Regenerate Report Index

    on:
      push:
        branches: [main]
        paths:
          - 'docs/history/nefario-reports/**.md'
          - 'docs/history/nefario-reports/build-index.sh'

    concurrency:
      group: regenerate-report-index
      cancel-in-progress: false

    permissions:
      contents: write

    jobs:
      regenerate-index:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

          - name: Regenerate index
            run: bash docs/history/nefario-reports/build-index.sh

          - name: Commit if changed
            run: |
              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
              git add docs/history/nefario-reports/index.md
              git diff --cached --quiet || git commit -m "docs: regenerate nefario report index [skip ci]"
              git push
    ```

    Also verify that `docs/history/nefario-reports/build-index.sh` is
    POSIX-compatible and will run correctly on ubuntu-latest. The script
    declares `#!/bin/sh` and uses grep, sed, sort, printf, mv. Confirm
    there are no bashisms or macOS-specific behavior (BSD sed flags, etc.).
    If any issues are found, fix them.

    Do NOT modify any other files. Do NOT touch documentation or gitignore.
    Those are handled by other agents.

- **Deliverables**: `.github/workflows/regenerate-report-index.yml`; verification that `build-index.sh` is POSIX-clean
- **Success criteria**: Workflow file exists with correct content; build-index.sh review confirms POSIX compatibility

### Task 2: Remove index.md from git tracking and add to gitignore

- **Agent**: devx-minion
- **Model**: sonnet
- **Mode**: bypassPermissions
- **Blocked by**: none
- **Approval gate**: no
- **Prompt**: |
    Two operations to stop tracking the derived index file:

    1. Add `docs/history/nefario-reports/index.md` to `.gitignore`.
       Place it in the "Project-specific" section at the top, after the
       existing `backlog/` entry. Add a comment line above it:
       `# Derived file, regenerated by CI`

    2. Run: `git rm --cached docs/history/nefario-reports/index.md`
       This removes it from git tracking without deleting the local file.

    The `.gitignore` file is at the repo root. The current project-specific
    section looks like:

    ```
    # =============================================================================
    # Project-specific
    # =============================================================================
    CLAUDE.local.md
    CROSS-CHECK-REPORT.md
    backlog/
    ```

    After your edit it should look like:

    ```
    # =============================================================================
    # Project-specific
    # =============================================================================
    CLAUDE.local.md
    CROSS-CHECK-REPORT.md
    backlog/

    # Derived file, regenerated by CI
    docs/history/nefario-reports/index.md
    ```

    Do NOT modify any other files. Do NOT edit documentation.

- **Deliverables**: Updated `.gitignore`; `index.md` removed from git index
- **Success criteria**: `git status` shows `.gitignore` modified and `index.md` deleted from tracking; `index.md` still exists on disk

### Task 3: Update documentation to reflect CI-based index generation

- **Agent**: devx-minion
- **Model**: sonnet
- **Mode**: default
- **Blocked by**: none
- **Approval gate**: no
- **Prompt**: |
    Update four files to remove local index regeneration instructions and
    replace with CI-based approach. All edits are paragraph-level replacements.

    **File 1: `CLAUDE.md`** (repo root, lines 58-62)

    Replace the current "Orchestration Reports" section:

    ```
    ## Orchestration Reports

    After completing nefario orchestration (conversations involving META-PLAN or SYNTHESIS phases),
    generate an execution report following the template at `docs/history/nefario-reports/TEMPLATE.md` and
    regenerate the index by running `docs/history/nefario-reports/build-index.sh`.
    ```

    With:

    ```
    ## Orchestration Reports

    After completing nefario orchestration (conversations involving META-PLAN or SYNTHESIS phases),
    generate an execution report following the template at `docs/history/nefario-reports/TEMPLATE.md`.
    The report index is regenerated automatically by CI on push to main.
    ```

    **File 2: `skills/nefario/SKILL.md`** -- Two edits:

    Edit A (line 704-706): In the "Verify and report" step, change:
    ```
    9. **Verify and report** — follow the wrap-up sequence documented in the
       "Report Generation" section below (review deliverables, write report,
       update index, present to user, shutdown teammates, final status).
    ```
    To:
    ```
    9. **Verify and report** — follow the wrap-up sequence documented in the
       "Report Generation" section below (review deliverables, write report,
       present to user, shutdown teammates, final status).
    ```
    (Remove "update index, " from the parenthetical.)

    Edit B (lines 859-866): Remove step 7 (index regeneration) and renumber:

    Current:
    ```
    7. **Regenerate index** by running `docs/history/nefario-reports/build-index.sh`
    8. Commit the report and companion directory together (auto-commit, no prompt needed)
    9. Offer PR creation if on a feature branch
    10. Return to main: `git checkout main && git pull --rebase`
    11. Present report path, PR URL, branch name, and Verification summary to user
    12. Send shutdown_request to teammates
    13. TeamDelete
    14. Report final status to user
    ```

    Replace with:
    ```
    7. Commit the report and companion directory together (auto-commit, no prompt needed)
    8. Offer PR creation if on a feature branch
    9. Return to main: `git checkout main && git pull --rebase`
    10. Present report path, PR URL, branch name, and Verification summary to user
    11. Send shutdown_request to teammates
    12. TeamDelete
    13. Report final status to user
    ```

    **File 3: `docs/history/nefario-reports/TEMPLATE.md`** -- Two edits:

    Edit A (lines 341-355): Replace the "Index File Update" section:

    Current:
    ```
    ## Index File Update

    After writing the report, regenerate the index by running:

        docs/history/nefario-reports/build-index.sh

    This script reads YAML frontmatter from all report files and produces
    a complete `docs/history/nefario-reports/index.md`. It is idempotent -- running it
    multiple times produces the same output. The index is a derived view,
    not primary state.

    If the script is unavailable, the index can be regenerated later by
    any session that runs the script. A stale index is a soft failure --
    all report files remain intact.
    ```

    Replace with:
    ```
    ## Index File

    The report index (`docs/history/nefario-reports/index.md`) is a derived view
    generated automatically by CI on push to main. It is not committed from branches
    and is not part of the orchestration workflow.

    The index is built by `docs/history/nefario-reports/build-index.sh`, which reads
    YAML frontmatter from all report files and produces a chronological table. The
    script is idempotent -- running it multiple times produces the same output.

    To preview the index locally: `docs/history/nefario-reports/build-index.sh`
    ```

    Edit B (lines 377-378): Replace step 14 in the Report Writing Checklist:

    Current:
    ```
    14. Regenerate index by running docs/history/nefario-reports/build-index.sh
    15. Present report path to user
    ```

    Replace with:
    ```
    14. Present report path to user
    ```
    (Remove the index regeneration step; renumber 15 to 14.)

    **File 4: `docs/orchestration.md`** (lines 528-530)

    Replace the "Index" subsection:

    Current:
    ```
    ### Index

    All reports are cataloged in `docs/history/nefario-reports/index.md`, a table listing date, time, task summary (as a link to the report), outcome, and agent count. The index is a derived view, regenerated by `docs/history/nefario-reports/build-index.sh` from report frontmatter. It provides a chronological view of all orchestration runs for cross-run analysis.
    ```

    Replace with:
    ```
    ### Index

    All reports are cataloged in `docs/history/nefario-reports/index.md`, a table listing date, time, task summary (as a link to the report), outcome, and agent count. The index is a derived view, regenerated automatically by CI (GitHub Actions) on push to main. The build script (`docs/history/nefario-reports/build-index.sh`) can also be run locally to preview the index. It provides a chronological view of all orchestration runs for cross-run analysis.
    ```

    Do NOT modify any other files. Do NOT create or modify the GitHub Actions
    workflow or .gitignore -- those are handled by other agents.

- **Deliverables**: Updated `CLAUDE.md`, `skills/nefario/SKILL.md`, `docs/history/nefario-reports/TEMPLATE.md`, `docs/orchestration.md`
- **Success criteria**: All four files updated with CI-based language; no references to local index regeneration remain in orchestration instructions

---

## Cross-Cutting Coverage

- **Testing**: Not applicable. No executable code is produced -- only a CI workflow YAML and documentation edits. The CI workflow is a declarative GitHub Actions config that will be validated by GitHub on first run. No unit/integration tests to write.
- **Security**: Covered by iac-minion's design: pinned action SHA, `[skip ci]` to prevent loops, minimal `contents: write` permission, bot identity for commits. No secrets, no external API calls, no user input processing.
- **Usability -- Strategy**: Not applicable. This change is invisible to end users. It affects only the developer workflow (one fewer manual step during orchestration).
- **Usability -- Design**: Not applicable. No user-facing interfaces.
- **Documentation**: Covered by Task 3 (4 files updated to reflect the new CI-based approach).
- **Observability**: Not applicable. No runtime components produced. The GitHub Actions workflow has built-in logging via the Actions UI.

## Architecture Review Agents

- **Always**: security-minion, test-minion, ux-strategy-minion, software-docs-minion, lucy, margo
- **Conditional**: none triggered (no runtime components, no user-facing interfaces, no web UI)

## Risks and Mitigations

| Risk | Severity | Mitigation |
|------|----------|------------|
| Push race on rapid sequential merges | LOW | `concurrency` block serializes workflow runs (included in Task 1) |
| CI workflow triggers itself in a loop | MEDIUM | `[skip ci]` in commit message (included in Task 1) |
| Path filter misses first commit | LOW | One-time transition; next report push triggers correctly. No functional impact. |
| Branch protection blocks bot push | LOW | Existing `vibe-coded-badge.yml` uses same pattern successfully. |
| Stale local index after transition | LOW | TEMPLATE.md includes local preview instructions. Non-functional file. |
| Brief window where index.md absent on main | LOW | Seconds at most. Index is informational, not functional. |

## Execution Order

All three tasks are independent and can run in parallel:

```
Batch 1 (parallel, no gates):
  Task 1: Create GitHub Actions workflow       [iac-minion]
  Task 2: git rm + gitignore                   [devx-minion]
  Task 3: Update 4 documentation files         [devx-minion]
```

All changes land in one PR. Atomicity is at merge time -- all three tasks' changes are committed together on the feature branch before PR creation.

Note: Tasks 2 and 3 are both assigned to devx-minion. When spawning as team agents, use distinct names (e.g., `devx-minion-git` and `devx-minion-docs`) or run them sequentially on a single devx-minion instance. Running them as a single agent with two sequential subtasks is preferred to avoid file contention (both touch the repo, though different files).

**Revised recommendation**: Merge Tasks 2 and 3 into a single devx-minion spawn. The git rm operation takes one command and the doc edits are paragraph-level -- one agent can handle both in sequence with no coordination overhead. This reduces from 3 spawns to 2.

## Verification Steps

After all tasks complete:

1. `git status` shows: `.gitignore` modified, `index.md` deleted from tracking, workflow YAML created, 4 docs updated
2. `grep -r "build-index.sh" CLAUDE.md skills/nefario/SKILL.md docs/history/nefario-reports/TEMPLATE.md docs/orchestration.md` returns zero matches for imperative "run" instructions (the script path may still appear in descriptive context, which is correct)
3. `.github/workflows/regenerate-report-index.yml` exists and contains `[skip ci]`, `concurrency`, and pinned checkout SHA
4. `docs/history/nefario-reports/index.md` is in `.gitignore`
5. `git ls-files docs/history/nefario-reports/index.md` returns empty (not tracked)
6. All existing report files in `docs/history/nefario-reports/` are untouched
